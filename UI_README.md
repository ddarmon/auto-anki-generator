# Auto Anki Review UI

Interactive web interface for reviewing and managing proposed Anki cards generated by the Auto Anki Agent.

## Features

This implements the **Interactive Review Mode** from `FUTURE_DIRECTIONS.md` (sections 11-13):

### Card Review
- **Card-by-card review** with full front/back display
- **Accept/Reject/Edit/Skip** actions with keyboard shortcuts
- **Edit mode** for refining cards before acceptance
- **Navigation** - next, previous, or jump to specific card
- **Progress tracking** - visual progress bar and statistics

### Rich Context Display
- **Source conversation** - see the original user question and assistant answer
- **Metadata** - conversation title, URL, file path
- **Quality signals** - view the heuristic signals that scored this context
- **Confidence scores** - see the LLM's confidence in each card

### Dashboard & Statistics
- **Session stats** - total cards, reviewed, remaining
- **Action breakdown** - count of accepted/rejected/edited/skipped cards
- **Real-time updates** - stats update as you review

### Export Functionality
- **Export accepted cards** - generate JSON file with only accepted/edited cards
- **Timestamp tracking** - know when decisions were made
- **Preserve edits** - edited cards are saved with modifications

## Installation

### Option 1: With uv (Recommended)

The UI dependencies are optional and can be installed with:

```bash
uv pip install -e ".[ui]"
```

Or run directly without installation:

```bash
uv run --with shiny --with pandas --with plotly shiny run anki_review_ui.py
```

### Option 2: With pip

```bash
pip install shiny pandas plotly
```

## Usage

### Start the UI

From the project directory:

```bash
shiny run anki_review_ui.py
```

Or specify a port:

```bash
shiny run anki_review_ui.py --port 8000
```

The app will automatically open in your browser at `http://localhost:8000`.

### Review Workflow

1. **Select a run** - Choose from recent Auto Anki Agent runs
2. **Review cards** - Navigate through proposed cards
3. **Make decisions**:
   - **Accept** ✓ - Mark card as good, move to next
   - **Reject** ✗ - Mark card as bad, move to next
   - **Edit** ✎ - Modify front/back/tags, then save
   - **Skip** ⊙ - Mark for later review, move to next
4. **Navigate** - Use Next/Previous or Jump to specific card
5. **Export** - When done, export accepted cards to JSON

### Keyboard Shortcuts (Coming Soon)

Planned shortcuts:
- `a` - Accept
- `r` - Reject
- `e` - Edit
- `s` - Skip
- `→` - Next card
- `←` - Previous card

## Output

### Accepted Cards Export

When you click "Export Accepted Cards", a new file is created:

```
auto_anki_runs/run-YYYYMMDD-HHMMSS/accepted_cards_YYYYMMDD-HHMMSS.json
```

This file contains only the cards you accepted or edited, ready for import to Anki.

Format:
```json
[
  {
    "context_id": "...",
    "deck": "Technology Learning",
    "card_style": "basic",
    "front": "What is...",
    "back": "...",
    "tags": ["tag1", "tag2"],
    "confidence": 0.95,
    "notes": "Why this card was created"
  }
]
```

## UI Components

### Card Display
- **Front** - Question or prompt (blue border)
- **Back** - Answer or explanation (green border)
- **Metadata** - Deck, tags, confidence score
- **Notes** - LLM's rationale for creating this card

### Source Context
- **User Prompt** - Original question from conversation
- **Assistant Answer** - Original response (truncated if long)
- **Metadata** - Title, URL, file path, quality score
- **Quality Signals** - Heuristic signals (question-like, definition-like, etc.)

### Statistics Panel
- **Session Summary** - Total, reviewed, remaining counts
- **Action Breakdown** - Counts by decision type
- **Filters** - Filter by deck, minimum confidence (coming soon)
- **Navigation** - Jump to specific card number

## Advanced Usage

### Filtering (Partial Implementation)

The UI includes placeholders for filtering:
- **By Deck** - Show only cards for specific deck
- **By Confidence** - Show only high-confidence cards

These filters are implemented in the UI but not yet fully functional.

### Bulk Operations (Coming Soon)

Future enhancements:
- **Accept all high-confidence** - Auto-accept cards above threshold
- **Reject all low-confidence** - Auto-reject cards below threshold
- **Batch edit** - Apply tag changes to multiple cards

## Architecture

### Session State

The `CardReviewSession` class manages:
- Loading cards from `all_proposed_cards.json`
- Loading contexts from `selected_contexts.json`
- Tracking decisions (accept/reject/edit/skip)
- Computing statistics
- Exporting accepted cards

### Reactive Updates

The Shiny app uses reactive programming:
- **Reactive values** - Session state, current card index
- **Reactive effects** - Button clicks trigger state updates
- **Reactive outputs** - UI updates automatically when state changes

### Data Flow

```
Run Directory
  ├─ all_proposed_cards.json  ──→ Cards list
  ├─ selected_contexts.json   ──→ Context lookup
  └─ (user decisions)         ──→ Session state
                              ──→ accepted_cards_*.json
```

## Troubleshooting

### No runs found

**Problem**: "No runs found" in the dropdown

**Solution**:
- Check that `auto_anki_runs/` directory exists
- Run `auto_anki_agent.py` to generate some cards first
- Ensure run directories are named `run-YYYYMMDD-HHMMSS`

### Cards not loading

**Problem**: Selected run but no cards displayed

**Solution**:
- Verify `all_proposed_cards.json` exists in run directory
- Check JSON is valid (not truncated or malformed)
- Look for error messages in terminal where Shiny is running

### Export not working

**Problem**: Export button doesn't create file

**Solution**:
- Check write permissions on run directory
- Verify at least one card has been accepted/edited
- Check terminal for error messages

## Comparison to FUTURE_DIRECTIONS.md

This implementation covers:

✅ **Interactive Review Mode** (Section 11)
- Terminal-style UI adapted to web interface
- Accept/reject/edit/skip actions
- Card navigation

✅ **Rich Previews & Context** (Section 12)
- Source context display
- Metadata (file, URL, score)
- Quality signals
- Confidence scores

✅ **Progress Dashboard** (Section 13)
- Real-time progress tracking
- Session statistics
- Action breakdown

⏳ **Partial Implementation**:
- Filtering (UI exists, logic incomplete)
- Keyboard shortcuts (planned)

❌ **Not Yet Implemented**:
- Topic distribution visualization
- Cost tracking
- Historical run comparison
- Notifications

## Next Steps

See `FUTURE_DIRECTIONS.md` for planned enhancements:

1. **Complete filtering** - Make deck/confidence filters functional
2. **Add keyboard shortcuts** - Faster review workflow
3. **Topic visualization** - Plotly charts showing deck coverage
4. **Batch operations** - Accept/reject multiple cards at once
5. **Feedback tracking** - Record rejection reasons for learning
6. **Integration** - Launch directly from auto_anki_agent.py
7. **AnkiConnect** - Direct import to Anki (no manual copy/paste)

## Example Session

```bash
# 1. Generate some cards
python3 auto_anki_agent.py --unprocessed-only --verbose

# 2. Launch review UI
shiny run anki_review_ui.py

# 3. In browser:
#    - Select latest run from dropdown
#    - Review cards one by one
#    - Accept good cards, reject bad ones, edit mediocre ones
#    - Export accepted cards when done

# 4. Import to Anki
#    - Copy accepted_cards_*.json content
#    - Paste into Anki import dialog
```

## Development

### File Structure

```python
anki_review_ui.py
├─ CardReviewSession       # State management
│  ├─ _load_cards()        # Load from JSON
│  ├─ _load_contexts()     # Load contexts
│  ├─ record_decision()    # Track accept/reject/etc
│  ├─ get_stats()          # Compute statistics
│  └─ export_accepted()    # Export to JSON
├─ app_ui                  # Shiny UI definition
│  ├─ Run selection
│  ├─ Card display
│  ├─ Action buttons
│  ├─ Context panel
│  └─ Statistics sidebar
└─ server()                # Shiny server logic
   ├─ Reactive values
   ├─ Output renderers
   └─ Event handlers
```

### Adding Features

To add a new feature:

1. **Update `CardReviewSession`** if it needs state
2. **Add UI elements** in `app_ui`
3. **Add server logic** in `server()`
4. **Connect with reactive** effects/outputs

Example - adding a "favorite" button:

```python
# In app_ui:
ui.input_action_button("btn_favorite", "⭐ Favorite")

# In server():
@reactive.Effect
@reactive.event(input.btn_favorite)
def _():
    session = session_state.get()
    if session:
        idx = current_card_index.get()
        session.record_decision(idx, 'favorite')
```

## Resources

- **Shiny for Python**: https://shiny.posit.co/py/
- **Shiny Gallery**: https://shiny.posit.co/py/gallery/
- **Auto Anki Agent Docs**: `README_AUTO_ANKI.md`
- **Future Roadmap**: `FUTURE_DIRECTIONS.md`
