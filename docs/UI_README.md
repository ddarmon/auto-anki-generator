# Auto Anki Review UI

Interactive web interface for reviewing and managing proposed Anki cards generated by the Auto Anki Agent.

## Features

This implements the **Interactive Review Mode** from `FUTURE_DIRECTIONS.md` (sections 11-13):

### Card Review
- **Card-by-card review** with full front/back display
- **Accept/Reject/Edit/Skip** actions with keyboard shortcuts
- **Edit mode** for refining cards before acceptance
- **Navigation** - next, previous, or jump to specific card
- **Progress tracking** - visual progress bar and statistics

### Rich Context Display
- **Source conversation** - see the original user question and assistant answer
- **Metadata** - conversation title, URL, file path
- **Quality signals** - view the heuristic signals that scored this context
- **Confidence scores** - see the LLM's confidence in each card

### Dashboard & Statistics
- **Session stats** - total cards, reviewed, remaining
- **Action breakdown** - count of accepted/rejected/edited/skipped cards
- **Real-time updates** - stats update as you review

### Codex-Powered Card Updates ‚úÖ NEW!
- **Inline Codex integration** - call `codex exec` directly from the UI
- **Model defaults** - uses `gpt-5.1` with low reasoning effort by default
- **Instruction-driven updates** - you tell Codex how to change the current card
- **Safe application** - suggestions populate the edit fields; you choose whether to save

### Export Functionality
- **Export accepted cards** - generate JSON file with only accepted/edited cards
- **Timestamp tracking** - know when decisions were made
- **Preserve edits** - edited cards are saved with modifications

## Installation

### Option 1: With uv (Recommended)

The UI dependencies are optional and can be installed with:

```bash
uv pip install -e ".[ui]"
```

Or run directly without installation:

```bash
uv run --with shiny --with pandas --with plotly shiny run anki_review_ui.py
```

### Option 2: With pip

```bash
pip install shiny pandas plotly
```

## Usage

### Start the UI

From the project directory:

```bash
shiny run anki_review_ui.py
```

Or specify a port:

```bash
shiny run anki_review_ui.py --port 8000
```

The app will automatically open in your browser at `http://localhost:8000`.

### Review Workflow

1. **Select a run** - Choose from recent Auto Anki Agent runs
2. **Review cards** - Navigate through proposed cards
3. **Make decisions**:
   - **Accept** ‚úì - Mark card as good, move to next
   - **Reject** ‚úó - Mark card as bad, move to next
   - **Edit** ‚úé - Modify front/back/tags, then save
   - **Skip** ‚äô - Mark for later review, move to next
4. **Navigate** - Use Next/Previous or Jump to specific card
5. **Export** - When done, export accepted cards to JSON

### Using Codex to Update a Card ‚úÖ NEW!

You can ask Codex (via codex-cli) to rewrite or fix the *current* card, using both the card content and its original conversation context.

1. Scroll to the **Codex Update** panel under the card.
2. Optionally fill in **Instructions for Codex (optional)** with how you want the card changed, e.g.:
   - `Shorten the answer to 1‚Äì2 sentences and emphasize intuition.`
   - `Convert this to a cloze deletion using [...] around the key term.`
   - `Flip front/back so the current answer becomes the question; make the new answer a concise definition.`
3. Click **"ü§ñ Suggest Update via Codex"**.
4. The app:
   - Builds a structured JSON-only prompt with the current card, its context, and your instructions.
   - Calls `codex exec` with `--model gpt-5.1` and low reasoning effort.
   - Parses the JSON response and fills the **Edit Card** fields (`Front`, `Back`, `Tags`) with the suggested update.
5. Review the suggested edits:
   - If you like them, click **Save Changes** to record this card as **edited**.
   - If not, you can tweak the fields manually, try different instructions, or ignore the suggestions.

Notes:
- Codex suggestions never overwrite your data automatically; they only pre-fill the editor.
- If `codex` is not on your `PATH`, the UI will show an error in the Codex status line.

### Keyboard Shortcuts ‚úÖ NEW!

**Review Actions:**
- `A` - Accept current card
- `R` - Reject current card (shows reason dropdown)
- `E` - Edit current card (opens editor)
- `S` - Skip current card (defer decision)

**Navigation:**
- `‚Üí` (Right Arrow) - Next card
- `‚Üê` (Left Arrow) - Previous card

**Tips:**
- Shortcuts work anywhere except when typing in input fields
- Look for `[A]`, `[R]`, etc. hints next to buttons
- Use arrows for quick navigation during review

## Output

### Accepted Cards Export

When you click "Export Accepted Cards", a new file is created:

```
auto_anki_runs/run-YYYYMMDD-HHMMSS/accepted_cards_YYYYMMDD-HHMMSS.json
```

This file contains only the cards you accepted or edited, ready for import to Anki.

Format:
```json
[
  {
    "context_id": "...",
    "deck": "Technology Learning",
    "card_style": "basic",
    "front": "What is...",
    "back": "...",
    "tags": ["tag1", "tag2"],
    "confidence": 0.95,
    "notes": "Why this card was created"
  }
]
```

## UI Components

### Card Display
- **Front** - Question or prompt (blue border)
- **Back** - Answer or explanation (green border)
- **Metadata** - Deck, tags, confidence score
- **Notes** - LLM's rationale for creating this card

### Source Context
- **User Prompt** - Original question from conversation
- **Assistant Answer** - Original response (truncated if long)
- **Metadata** - Title, URL, file path, quality score
- **Quality Signals** - Heuristic signals (question-like, definition-like, etc.)

### Statistics Panel
- **Session Summary** - Total, reviewed, remaining counts
- **Action Breakdown** - Counts by decision type
- **Filters** - Filter by deck, minimum confidence (coming soon)
- **Navigation** - Jump to specific card number

## Advanced Usage

### Filtering ‚úÖ NEW!

**Filter by Deck:**
1. Select deck from dropdown (e.g., "Technology Learning")
2. Click "Apply Filters"
3. Only cards from that deck will be shown

**Filter by Confidence:**
1. Drag slider to minimum confidence (e.g., 0.85 for 85%)
2. Click "Apply Filters"
3. Only cards above threshold will be shown

**Combine Filters:**
- Use both deck + confidence filters together
- Status message shows: "‚úì Showing X of Y cards"
- Filtered cards are navigable with Next/Previous/Jump

**Reset Filters:**
- Select "All Decks" and set confidence to 0.0
- Click "Apply Filters" to see all cards again

### Bulk Operations ‚úÖ NEW!

**Accept All High Confidence:**
1. Set threshold slider (default: 90%)
2. Click "Accept All High Confidence"
3. All unreviewed cards above threshold are auto-accepted
4. Status message shows count: "‚úì Auto-accepted 18 cards"
5. Review stats update immediately

**Use Cases:**
- Process high-quality batch runs quickly
- Accept obvious cards, review marginal ones
- Save time on 95%+ confidence cards

**Note**: Bulk accept only affects unreviewed cards (won't override existing decisions)

### Rejection Reasons ‚úÖ NEW!

**Why Track Reasons:**
- Understand patterns in card quality
- Improve prompt engineering
- Train better quality predictors
- Export for analysis

**How to Use:**
1. Click "Reject" button (or press `R`)
2. Dropdown appears with reason options
3. Select reason (optional but recommended)
4. If "Other", enter custom text
5. Move to next card

**Predefined Reasons:**
- **Duplicate** - Too similar to existing card
- **Low quality** - Poorly phrased or unclear
- **Not relevant** - Out of scope for deck
- **Too vague** - Lacks sufficient context
- **Too specific** - Overly detailed
- **Factually wrong** - Incorrect information
- **Other** - Custom reason (text input)

**Export Feedback:**
- Click "Export Feedback Data" button
- Creates `feedback_data_TIMESTAMP.json`
- Includes all decisions with reasons
- Use for analysis and improvement

## Architecture

### Session State

The `CardReviewSession` class manages:
- Loading cards from `all_proposed_cards.json`
- Loading contexts from `selected_contexts.json`
- Tracking decisions (accept/reject/edit/skip)
- Computing statistics
- Exporting accepted cards

### Reactive Updates

The Shiny app uses reactive programming:
- **Reactive values** - Session state, current card index
- **Reactive effects** - Button clicks trigger state updates
- **Reactive outputs** - UI updates automatically when state changes

### Data Flow

```
Run Directory
  ‚îú‚îÄ all_proposed_cards.json  ‚îÄ‚îÄ‚Üí Cards list
  ‚îú‚îÄ selected_contexts.json   ‚îÄ‚îÄ‚Üí Context lookup
  ‚îî‚îÄ (user decisions)         ‚îÄ‚îÄ‚Üí Session state
                              ‚îÄ‚îÄ‚Üí accepted_cards_*.json
```

## Troubleshooting

### No runs found

**Problem**: "No runs found" in the dropdown

**Solution**:
- Check that `auto_anki_runs/` directory exists
- Run `auto_anki_agent.py` to generate some cards first
- Ensure run directories are named `run-YYYYMMDD-HHMMSS`

### Cards not loading

**Problem**: Selected run but no cards displayed

**Solution**:
- Verify `all_proposed_cards.json` exists in run directory
- Check JSON is valid (not truncated or malformed)
- Look for error messages in terminal where Shiny is running

### Export not working

**Problem**: Export button doesn't create file

**Solution**:
- Check write permissions on run directory
- Verify at least one card has been accepted/edited
- Check terminal for error messages

## Comparison to FUTURE_DIRECTIONS.md

This implementation covers:

‚úÖ **Interactive Review Mode** (Section 11)
- Terminal-style UI adapted to web interface
- Accept/reject/edit/skip actions
- Card navigation

‚úÖ **Rich Previews & Context** (Section 12)
- Source context display
- Metadata (file, URL, score)
- Quality signals
- Confidence scores

‚úÖ **Progress Dashboard** (Section 13)
- Real-time progress tracking
- Session statistics
- Action breakdown

‚è≥ **Partial Implementation**:
- Filtering (UI exists, logic incomplete)
- Keyboard shortcuts (planned)

‚ùå **Not Yet Implemented**:
- Topic distribution visualization
- Cost tracking
- Historical run comparison
- Notifications

## Next Steps

See `FUTURE_DIRECTIONS.md` for planned enhancements:

1. **Complete filtering** - Make deck/confidence filters functional
2. **Add keyboard shortcuts** - Faster review workflow
3. **Topic visualization** - Plotly charts showing deck coverage
4. **Batch operations** - Accept/reject multiple cards at once
5. **Feedback tracking** - Record rejection reasons for learning
6. **Integration** - Launch directly from auto_anki_agent.py
7. **AnkiConnect** - Direct import to Anki (no manual copy/paste)

## Example Session

```bash
# 1. Generate some cards
python3 auto_anki_agent.py --unprocessed-only --verbose

# 2. Launch review UI
shiny run anki_review_ui.py

# 3. In browser:
#    - Select latest run from dropdown
#    - Review cards one by one
#    - Accept good cards, reject bad ones, edit mediocre ones
#    - Export accepted cards when done

# 4. Import to Anki
#    - Copy accepted_cards_*.json content
#    - Paste into Anki import dialog
```

## Development

### File Structure

```python
anki_review_ui.py
‚îú‚îÄ CardReviewSession       # State management
‚îÇ  ‚îú‚îÄ _load_cards()        # Load from JSON
‚îÇ  ‚îú‚îÄ _load_contexts()     # Load contexts
‚îÇ  ‚îú‚îÄ record_decision()    # Track accept/reject/etc
‚îÇ  ‚îú‚îÄ get_stats()          # Compute statistics
‚îÇ  ‚îî‚îÄ export_accepted()    # Export to JSON
‚îú‚îÄ app_ui                  # Shiny UI definition
‚îÇ  ‚îú‚îÄ Run selection
‚îÇ  ‚îú‚îÄ Card display
‚îÇ  ‚îú‚îÄ Action buttons
‚îÇ  ‚îú‚îÄ Context panel
‚îÇ  ‚îî‚îÄ Statistics sidebar
‚îî‚îÄ server()                # Shiny server logic
   ‚îú‚îÄ Reactive values
   ‚îú‚îÄ Output renderers
   ‚îî‚îÄ Event handlers
```

### Adding Features

To add a new feature:

1. **Update `CardReviewSession`** if it needs state
2. **Add UI elements** in `app_ui`
3. **Add server logic** in `server()`
4. **Connect with reactive** effects/outputs

Example - adding a "favorite" button:

```python
# In app_ui:
ui.input_action_button("btn_favorite", "‚≠ê Favorite")

# In server():
@reactive.Effect
@reactive.event(input.btn_favorite)
def _():
    session = session_state.get()
    if session:
        idx = current_card_index.get()
        session.record_decision(idx, 'favorite')
```

## Resources

- **Shiny for Python**: https://shiny.posit.co/py/
- **Shiny Gallery**: https://shiny.posit.co/py/gallery/
- **Auto Anki Agent Docs**: `README_AUTO_ANKI.md`
- **Future Roadmap**: `FUTURE_DIRECTIONS.md`
